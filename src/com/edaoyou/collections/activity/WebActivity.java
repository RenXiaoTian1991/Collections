package com.edaoyou.collections.activity;import android.annotation.SuppressLint;import android.content.Intent;import android.graphics.Bitmap;import android.os.Bundle;import android.text.TextUtils;import android.view.View;import android.view.View.OnClickListener;import android.webkit.WebView;import android.webkit.WebViewClient;import android.widget.ImageButton;import android.widget.RelativeLayout;import com.edaoyou.collections.GlobalParams;import com.edaoyou.collections.R;import com.edaoyou.collections.base.BaseActivity;import com.edaoyou.collections.utils.BimpUtil;import com.edaoyou.collections.view.ShareView;import com.sina.weibo.sdk.api.ImageObject;import com.sina.weibo.sdk.api.TextObject;import com.sina.weibo.sdk.api.WeiboMultiMessage;import com.sina.weibo.sdk.auth.AuthInfo;import com.sina.weibo.sdk.auth.sso.SsoHandler;import com.tencent.connect.share.QQShare;import com.tencent.mm.sdk.modelmsg.WXMediaMessage;import com.tencent.mm.sdk.modelmsg.WXWebpageObject;public class WebActivity extends BaseActivity implements OnClickListener {	private ImageButton articles_black_share_ib;	private WebView articles_web_wv;	private RelativeLayout articles_load_rl;	private ShareView mShareView; // 分享view	private SsoHandler mSsoHandler;// 新浪微博api	private AuthInfo mAuthInfo;	private String mUrl;	private String mTitle;	private String mContent;	private String mPhotoUrl;	@Override	protected void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		initWebView();		Intent intent = getIntent();		mTitle = intent.getStringExtra(GlobalParams.WEB_TITLE);		mContent = intent.getStringExtra(GlobalParams.WEB_CONTENT);		mPhotoUrl = intent.getStringExtra(GlobalParams.WEB_PHOTO);	}	@Override	protected int setContentView() {		return R.layout.activity_web;	}	@Override	protected void findViews() {		articles_black_share_ib = (ImageButton) findViewById(R.id.articles_black_share_ib);		articles_load_rl = (RelativeLayout) findViewById(R.id.articles_load_rl);		articles_web_wv = (WebView) findViewById(R.id.articles_web_wv);	}	@Override	protected void setListensers() {		articles_black_share_ib.setOnClickListener(this);	}	@SuppressLint("SetJavaScriptEnabled")	private void initWebView() {		mUrl = getIntent().getStringExtra(GlobalParams.WEB_URL);		if (TextUtils.isEmpty(mUrl)) {			return;		}		articles_web_wv.getSettings().setJavaScriptEnabled(true); // WebView可以执行Javascript脚本		articles_web_wv.loadUrl(mUrl);		articles_web_wv.setWebViewClient(mWebViewClient);	}	private WebViewClient mWebViewClient = new WebViewClient() {		@Override		public void onPageFinished(WebView view, String url) {			super.onPageFinished(view, url);			articles_load_rl.setVisibility(View.GONE);		}	};	private void showShareDialog() {		if (TextUtils.isEmpty(mTitle) || TextUtils.isEmpty(mContent) || TextUtils.isEmpty(mPhotoUrl)) {			return;		}		if (mShareView == null) {			mShareView = new ShareView(this);			mAuthInfo = new AuthInfo(this, GlobalParams.WEI_BO_APP_KEY, GlobalParams.WEI_BO_REDIRECT_URL, GlobalParams.WEI_BO_SCOPE);			mSsoHandler = new SsoHandler(this, mAuthInfo);		}		mShareView.setQQData(getShareQQData());		mShareView.setWeiXinData(getShareWeiXinData());		mShareView.setWeiboData(mSsoHandler, mAuthInfo, getShareWeiBoData());		mShareView.show(false, ShareView.NO_REPROT);	}	/**	 * http://182.92.195.162:8088/wap.php?r=wap/share/index&id=12&type=1&key	 * =46f94c8de14fb36680850768ff1b7f2a&lang=zh-cn type 1 琳琅 2 feed照片详情 3 资讯 4	 * 活动 5 App分享 key 反转id	 */	private String getShareUrl(boolean isShareToWeiXin) {		String url;		if (isShareToWeiXin) {			url = mUrl + "&channel=wx";		} else {			url = mUrl;		}		return url.replace("&amp;", "&");	}	/**	 * 获得分享qq内容	 */	private Bundle getShareQQData() {		Bundle bundle = new Bundle();		String shareUrl = getShareUrl(false);		// 这条分享消息被好友点击后的跳转URL。		bundle.putString(QQShare.SHARE_TO_QQ_TARGET_URL, shareUrl);		// 分享的标题。注：PARAM_TITLE、PARAM_IMAGE_URL、PARAM_ SUMMARY不能全为空，最少必须有一个是有值的。		bundle.putString(QQShare.SHARE_TO_QQ_TITLE, mTitle);		// 分享的图片URL		bundle.putString(QQShare.SHARE_TO_QQ_IMAGE_URL, mPhotoUrl);		// 分享的消息摘要，最长50个字		bundle.putString(QQShare.SHARE_TO_QQ_SUMMARY, mContent);		// 手Q客户端顶部，替换“返回”按钮文字，如果为空，用返回代替		bundle.putString(QQShare.SHARE_TO_QQ_APP_NAME, getString(R.string.app_name));		// 标识该消息的来源应用，值为应用名称+AppId。		bundle.putString(QQShare.SHARE_TO_QQ_KEY_TYPE, getString(R.string.app_name) + GlobalParams.QQ_APP_ID);		return bundle;	}	@Override	protected void onActivityResult(int requestCode, int resultCode, Intent intent) {		super.onActivityResult(requestCode, resultCode, intent);		if (mSsoHandler != null) {// 新浪微博 SSO 登录授权时，需要加上			mSsoHandler.authorizeCallBack(requestCode, resultCode, intent);		}	}	/**	 * 获得分享微信内容	 */	private WXMediaMessage getShareWeiXinData() {		WXMediaMessage msg = new WXMediaMessage();		Bitmap bitmapFromDiskCache = mBitmapUtils.getBitmapFromCache(mPhotoUrl);		byte[] arr = BimpUtil.bmpToByteArray(bitmapFromDiskCache);		msg.thumbData = arr;		msg.title = mTitle;		msg.description = mContent;		WXWebpageObject web = new WXWebpageObject();		String shareUrl = getShareUrl(true);		web.webpageUrl = shareUrl;		msg.mediaObject = web;		return msg;	}	/**	 * 获得分享微博内容	 */	private WeiboMultiMessage getShareWeiBoData() {		// 1. 初始化微博的分享消息		WeiboMultiMessage weiboMessage = new WeiboMultiMessage();		// 文字		TextObject textObject = new TextObject();		String shareUrl = getShareUrl(false);		textObject.text = mTitle + shareUrl;		weiboMessage.textObject = textObject;		// 图片		ImageObject imageObject = new ImageObject();		Bitmap bm = BimpUtil.compressImage(mBitmapUtils.getBitmapFromCache(mPhotoUrl));		imageObject.setImageObject(bm);		weiboMessage.imageObject = imageObject;		return weiboMessage;	}	@Override	public void onClick(View view) {		switch (view.getId()) {		case R.id.articles_black_share_ib:			showShareDialog();			break;		default:			break;		}	}}